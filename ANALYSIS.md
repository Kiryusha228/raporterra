# Анализ требований к ПО

## Архитектура ПО

### 1. Общая схема архитектуры

┌───────────────────────┐       ┌───────────────────────┐
│                       │       │                       │
│        Сервис         │       │       Основной        │
│    аутентификации     │───────┤     бизнес-сервис     │
│                       │ REST  │                       │
└───────────┬───────────┘       └───────────┬───────────┘
            │                               │            
            │                               │            
┌───────────▼───────────┐       ┌───────────▼───────────┐
│  PostgreSQL (auth_db) │       │       PostgreSQL      │
│                       │       │    (raporterra_db)    │
└───────────────────────┘       └───────────────────────┘

### 2. Сервис аутентификации

#### Компоненты
1) Пакет controller
  • AuthController.java - обработка HTTP-запросов:
    - /api/auth/register (POST) - регистрация
    - /api/auth/login (POST) - аутентификация
    - Использует DTO (RegisterRequest, AuthRequest, AuthResponse)
2) Пакет service
  • AuthService.java - ядро бизнес-логики аутентификации:
    - Валидация учетных данных
    - Работа с пользователями
  • JwtService.java - генерация/верификация JWT
  • CustomUserDetailsService.java - интеграция с Spring Security
3) Пакет repository
  • UserRepository.java - доступ к данным
4) Пакет model
  • Сущности:
    - User.java - основная модель пользователя
    - Role.java - enum ролей (ADMIN, ANALYST, USER)
  • DTO:
    - AuthRequest.java - запрос на вход
5) Пакет config
  • SecurityConfig.java - настройки Spring Security
  • JwtFilter.java - фильтр для проверки JWT
  • WebClientConfig.java - настройка HTTP-клиента
6) Пакет client
  • UserInfoClient.java - REST-клиент для интеграции с другими сервисами

### 3. Основной бизнес-сервис

#### Компоненты
1) Пакет controller
  • ReportController.java - управление отчётами (CRUD + выполнение)
  • CollectionController.java - работа с коллекциями
  • DatabaseConnectionController.java - подключения к БД
  • UserInfoController.java - информация о пользователях
  • GroupController.java - управление группами пользователей
2)  Пакет service
  • CollectionService.java - логика работы с коллекциями
  • DatabaseConnectionService.java - управление подключениями к БД
  • GroupService.java - логика управления группами пользователей
  • ReportQueueService.java - очередь выполнения отчётов
  • ReportService.java - логика управления отчётами
  • UserInfoService.java - формирование информации о пользователях
3) Пакет repository
JPA-репозитории для всех сущностей:
  • CollectionAccessRepository.java
  • CollectionReportRepository.java
  • CollectionRepository.java
  • DatabaseConnectionRepository.java
  • GroupRepository.java
  • ReportQueueRepository.java
  • ReportRepository.java
  • UserGroupRepository.java
  • UserInfoRepository.java
4) Пакет model
  • Entity:
  Все сущности из БД + отдельно вынесенные в сущности компоненты в Java-классах:
    collection:
      - Collection.java
      - CollectionAccess.java
      - CollectionReport.java
      - CollectionReportId.java
    dbconnection:
      - DatabaseConnection.java
    group:
      - Group.java
    report:
      - Report.java
      - ReportQueue.java
      - TaskStatus.java
    user:
      - Role.java
      - UserInfo.java
    usergroup:
      - UserGroup.java
      - UserGroupId.java
  • DTO:
    collection:
      - CollectionDto.java
      - CreateCollectionDto.java
      - UpdateCollectionDto.java
    connection:
      - CreateDatabaseConnectionDto.java
      - DatabaseConnectionDto.java
      - FullDatabaseConnectionDto.java
    exception:
      - ExceptionDto.java
    group
      - CreateGroupDto.java
      - GroupDto.java
      - UpdateGroupDto.java
    report:
      - AvailableReportsDto.java
      - CreateReportDto.java
      - ReportMetadataDto.java
      - ReportQueueResultDto.java
      - UpdateReportDto.java
    user:
      - CreateUserInfoDto.java
5) Пакет config
  • SecurityConfig.java - настройка Spring Security + JWT
  • JdbcConfig.java - конфигурация источников данных
  • SwaggerConfig.java - документация API
  • JwtFilter.java - фильтр аутентификации
  • JwtService.java - настройка JWT
6) Пакет exception
  • Специализированные исключения:
    - GlobalExceptionHandler.java - централизованный класс-обработчик
    - CollectionAccessDeniedException.java
    - CollectionNotFoundException.java
    - ConnectionNotFoundException.java
    - DatabaseConnectionNotFoundException.java
    - GroupNotFoundException.java
    - InvalidReportQueryException.java
    - ReportNotFoundException.java
    - UnsupportedDatabaseException.java
    - UserNotFoundException.java
7) Пакет component
  • Специальные компоненты:
    - ReportQueueWorker.java - фоновый обработчик очереди
    - ResultStorage.java - временное хранение результатов
8) Пакет mapper
  Классы для преобразований типов Entity ↔ DTO:
  • CollectionMapper.java
  • DatabaseConnectionMapper.java
  • GroupMapper.java
  • ReportMapper.java

## Варианты использования системы отчетов

### 1. Регистрация

#### UC-01: Регистрация в системе
**Актор:** Администратор  
**Предусловие:** -  
**Основной поток:**
1. Администратор переходит на страницу регистрации
2. Система отображает форму с полями (почта, имя пользователя, пароль, подтверждение пароля)
3. Администратор вводит данные пользователя
4. Система проверяет:
   - Соответствие формата email корпоративной почте
   - Уникальность email в системе
   - Сложность пароля
5. Система создаёт учётную запись пользователя

**Альтернативный поток:**
1. Если проверка данных неудачная, система предлагает ввести другие данные

**Постусловие:** Пользователь становится участником системы

---

### 2. Аутентификация и авторизация

#### UC-02: Вход в систему
**Актор:** Пользователь, Администратор, Аналитик  
**Предусловие:** Пользователь зарегистрирован в системе
##### Вход через email и пароль
**Основной поток:**
1. Пользователь открывает страницу входа и вводит email и пароль на страничке входа 
2. Фронтенд отправляет запрос на авторизацию POST /auth/login {email, password} в бекэнд
3. Сервис авторизации проверяет email:
   • Если email не оканчивается на @company.com, возвращается ошибка
4. Сервис авторизации проверяет пользователя по БД:
   • Ищет запись по email
   • Проверяет хэш пароля 
5. Если данные корректны бкэнд формирует JWT-токен, в который включается:
   • ID пользователя
   • Роль (USER, ANALYST, ADMIN)
6. Токен возвращается во фронтенд 
7. Фронтенд сохраняет токен 
8. Пользователь перенаправляется на главную страницу с доступом согласно своей роли 
##### Вход через OAuth-провайдера
**Основной поток:**
1. Пользователь нажимает «Войти через Яндекс(например)»
2. Фронтенд инициирует авторизацию через OAuth
3. После успешного входа, провайдер возвращает access_token и данные пользователя (email, имя и т.д.)
4. Фронтенд отправляет полученные данные POST /auth/login {email, access_token}в бэкенд 
5. Сервис авторизации проверяет email:
   • Должен заканчиваться на @company.com
6. Сервис авторизации проверяет пользователя по БД:
   • Ищет запись по email
7. Если данные корректны бкэнд формирует JWT-токен, в который включается:
   • ID пользователя
   • Роль (USER, ANALYST, ADMIN)
8. Токен возвращается во фронтенд 
9. Фронтенд сохраняет токен 
10. Пользователь перенаправляется на главную страницу с доступом согласно своей роли 

**Альтернативные поток:**
1) Некорпоративный email
1. Пользователь вводит email и пароль на странице входа.
2. Фронтенд отправляет запрос: POST /auth/login { email, password } 
3. Сервис авторизации:
   • Проверяет: email.endsWith('@company.com')
   • Условие не выполнено
4. Сервис автоизации не обращается к БД, сразу возвращает ошибку:
   • 403 Forbidden
   • Сообщение: "Доступ разрешён только с корпоративного email"
5. Фронтенд: показывает пользователю уведомление об ошибке 
2) Пользователь не найден (email корректный, но отсутствует в БД)
1. Пользователь вводит email и пароль
2. Фронтенд отправляет: POST /auth/login {email, password}
3. Сервис авторизации:
   • Проверяет email: @company.com
   • Обращается к БД: Результат: пустой
4. Бэкенд возвращает: 401 Unauthorized Сообщение: "Пользователь не найден"
5. Фронтенд: отображает сообщение об ошибке
3) Неверный пароль (email найден, но введён неверный пароль)
1. Пользователь вводит email и пароль
2. Фронтенд отправляет: POST /auth/login {email, password}
3. Сервис авторизации:
   • Проверяет email: @company.com
   • Выполняет запрос: находит пользователя
   • Сравнивает хэш пароля: условие не выполнено → пароль не совпадает
4. Бэкенд возвращает: 401 Unauthorized Сообщение: "Неверный пароль"
5. Фронтенд: показывает сообщение об ошибке

**Постусловие:** Пользователь получает доступ согласно своей роли

#### UC-03: Выход из системы
**Актор:** Пользователь, Администратор, Аналитик  
**Предусловие:** Пользователь вошёл в систему и имеет активный JWT-токен, сохранённый на клиенте  
**Основной поток:**
1. Пользователь нажимает «Выход» в пользовательском интерфейсе 
2. Фронтенд: отправляет запрос POST /auth/logout с заголовком Authorization: Bearer <JWT> на бэкенд.
3. Бэкенд:
   • Извлекает user_id из JWT.
   • Обращается к базе данных и находит пользователя по user_id.
   • Обновляет флаг: is_active = false
4. Бэкенд возвращает ответ 200 OK.
5. Фронтенд: 
   • Удаляет токен из хранилища.
   • Перенаправляет пользователя на страницу входа

---

### 3. Управление пользователями

#### UC-04: Назначение ролей
**Актор:** Администратор  
**Предусловие:** Пользователь существует в системе  
**Основной поток:**
1. Администратор открывает страницу управления пользователями 
2. Фронтенд отправляет запрос GET/users для загрузки списка пользователей
3. Бэкенд делает запрос к БД и возвращает список пользователей
4. Фронтенд отображает список
5. Администратор выбрает нужного пользователя и новую роль через представленную форму, нажимает кнопочку «Сохранить изменения»
6. Фронтенд отправляет запрос на изменение роли
7. Бэкенд: 
   • Проверяет существует ли такой пользователь 
   • Обновляет запись в БД
8. Бэкенд возвращает 200 OK, сообщение: «Роль успешно обновлена»
9. Фронтенд отображает уведомление об успешном изменении и обновляет UI

Валидация не нужна. У каждой роли пользователя свои возможности, следовательно и UI тоже, таким образом, никто кроме администратора не сможет выполнять его запросы. Выбор самой роли будет реализован через выпадающий список, следовательно, администратору не нужно вводить данные вручную, что снимает вопрос валидации.

#### UC-05: Просмотр списка пользователей
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает страницу управления пользователями 
2. Фронтенд отправляет запрос GET/users для загрузки списка пользователей
3.  Бэкенд делает запрос к БД и возвращает список пользователей
4. Фронтенд отображает список
5. Администратор выбирает фильтрацию по роли (роль из выпадающего списка)
6. Фронтенд отправляет запрос GET /users?role=… (например. ANALYST) для загрузки списка пользователей
7. Бэкенд делает запрос к БД с фильтром по роли и возвращает список пользователей
8. Фронтенд отображает отфильтрованный список 
тут по валидации тоже не вижу смысла ничего делать так как выбор из выпадающего списка, так же как и проверку роли (что запрос делает администратор)

#### UC-06: Создание групп пользователей
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает раздел "Группы пользователей"
2. Нажимает кнопку "Создать группу пользователей"
3. Система отображает форму создания группы
4. Администратор заполняет поля:
   - Название группы
   - Описание группы
5. Нажимает кнопку "Создать"
6. Система создаёт новую группу

#### UC-07: Добавление пользователей в группу
**Актор:** Администратор
**Предусловия:** 
   - Пользователь и группа существуют в системе
   - У текущего пользователя есть права на управление группами
   - Пользователь не состоит в данной группе  
**Основной поток:**
1. Администратор выбирает раздел "Группы пользователей"
2. Система отображает список всех групп с возможностью поиска
3. Администратор нажимает на конкретную группу
4. Система показывает:
   - Текущий состав группы
   - Кнопку "Добавить пользователей"
5. Администратор нажимает "Добавить пользователей"
6. Система открывает модальное окно с:
   - Поисковой строкой по email/имени
   - Списком доступных пользователей
   - Чекбоксами для выбора
7. Администратор выбирает одного или нескольких пользователей
8. Нажимает кнопку "Подтвердить"
9. Система проверяет, что пользователи не дублируются в группе
10. Добавляет выбранных пользователей в группу
11. Система обновляет состав группы
12. Показывает уведомление: "Пользователи успешно добавлены"

**Альтернативный поток:**
1. При попытке добавить пользователя, уже находящегося в группе, система показывает соответствующее предупреждение и не даёт повторно добавить пользователя

---

### 4. Работа с отчётами

#### UC-08: Создание отчёта
**Актор:** Аналитик, Администратор  
**Основной поток:**
1. Пользователь открывает страничку создания отчета в интерфейсе 
2. Фронтенд отправляет GET-запрос на получение подключенных БД
3. Бэкенд получает список подключений из таблицы database_connections и возвращает его (список имён БД)
4. Фронтенд отображает список (при выборе целевой БД)
5. Пользователь вводит: 
   • Название отчета 
   • SQL-запрос (только SELECT)
   • Целевая БД (из списка) подключений
   • Параметры
6. Фронтенд отправляет POST-запрос POST/reports
7. Бэкенд выполняет валидацию: 
   • Проверка, что SQL содержит только SELECT-запрос (read-only)
   • Проверка корректности параметров
8. Если все проверки успешны:
   • Бэкенд генерирует UUID
   • Формирует объект отчета
   • Сохраняет в таблицу reports
9. Бэкенд возвращает 201 Created и JSON с UUID отчета.
10. Фронтенд уведомляет пользователя: «Отчет успешно создан».
**Альтернативные потоки:** 
1)  Невалидный SQL-запрос
1. Пользователь вводит SQL-запрос, содержащий недопустимые конструкции (например, UPDATE, DELETE, INSERT).
2. Фронтенд отправляет: POST /reports.
3. Бэкенд проверяет SQL: запрос не проходит валидацию (например, не начинается с SELECT).
4. Бэкенд возвращает: 400 Bad Request Сообщение: «Недопустимый SQL-запрос. Допускаются только SELECT-запросы»
5. Фронтенд: уведомляет пользователя об ошибке в SQL.
2) Ошибка в параметрах
1. Пользователь добавляет параметры (например, start_date, end_date), но забывает обязательные поля или указывает некорректные типы.
2. Фронтенд отправляет: POST /reports.
3. Бэкенд проверяет параметры: отсутствуют обязательные поля, либо типы не соответствуют (например, start_date: «abc»).
4. Бэкенд возвращает: 400 Bad Request Сообщение: «Ошибка в параметрах запроса»
5. Фронтенд: выводит сообщение пользователю.
3) Отчёт с таким названием уже существует 
1. Пользователь создает отчет с названием, которое уже существует (например, для уникального имени внутри одной коллекции или владельца).
2. Фронтенд отправляет: POST /reports.
3. Бэкенд:
   • Проверяет имя отчета по условию уникальности
   • Находит дубликат
4. Бэкенд возвращает: 409 Conflict Сообщение: «Отчет с таким названием уже существует»
5. Фронтенд: предлагает пользователю изменить имя отчета.

#### UC-09: Выполнение отчёта
**Актор:** Пользователь  
**Предусловия:**
   - Пользователь авторизован в системе
   - У пользователя есть доступ хотя бы к одному отчёту
**Основной поток:**
1. Пользователь открывает раздел "Отчёты"
2. Система отображает список доступных отчётов (с фильтрами по категориям/коллекциям, если применимо)
3. Пользователь выбирает нужный отчёт
4. Пользователь нажимает кнопку "Сформировать отчёт"
5. Система проверяет доступность БД:
   - Если БД свободна – немедленно запускает выполнение
   - Если БД перегружена – ставит запрос в очередь и уведомляет пользователя ("Отчёт поставлен в очередь")
6. Система выполняет запрос к БД
6. При успешном выполнении возвращает результат в виде таблицы или графика

**Альтернативные потоки:**
1) Превышение времени выполнения (таймаут)
1. При превышении 5 минут выполнения система отменяет запрос
2. Пользователь получает уведомление: "Превышено время выполнения. Попробуйте повторить позже"
2) Ошибка доступа к БД
1. Если БД недоступна (нет соединения, ошибка аутентификации):
   - Система выводит сообщение: "База данных временно недоступна. Обратитесь к администратору"
   - Запрос не ставится в очередь
**Постусловие:** Отчёт сформирован и отображён пользователю

#### UC-10: Выгрузка в Excel
**Актор:** Пользователь  
**Предусловие:** Пользователь сформировал отчёт и находится на странице его просмотра
**Основной поток:**
1. Пользователь нажимает кнопку "Экспорт в Excel"
2. Система генерирует файл в формате .xlsx на основе данных отчёта
3. Система предоставляет пользователю ссылку для скачивания файла
**Постусловие:** Файл успешно сохранён на устройстве пользователя.

---

### 5. Управление коллекциями

#### UC-11: Создание коллекции
**Актор:** Аналитик, Администратор  
**Предусловие:** Пользователь авторизован и имеет права на создание коллекций.
**Основной поток:**
1. Пользователь переходит в раздел "Коллекции"
2. Нажимает кнопку "Создать коллекцию"
3. Вводит название коллекции (обязательно) и описание (опционально)
4. Система проверяет уникальность названия (в рамках текущего уровня вложенности)
5. Система создаёт коллекцию
6. Пользователь выбирает отчёты из списка доступных и добавляет их в коллекцию
**Постусловие:** Коллекция создана и содержит выбранные отчёты.

#### UC-12: Назначение доступа к коллекции
**Актор:** Администратор  
**Предусловие:** Коллекция существует, администратор имеет права на управление доступом.
**Основной поток:**
1. Администратор выбирает коллекцию в интерфейсе
2. Нажимает кнопку "Настроить доступ"
3. В открывшейся форме выбирает:
   - Тип доступа (индивидуальный / групповой)
   - Пользователей или группы из списка
   - Уровень доступа (чтение, редактирование, полный доступ)
4. Система сохраняет настройки доступа
**Постусловие:** Пользователи/группы получили указанный уровень доступа к коллекции.

---

### 6. Запросы на создание отчетов

#### UC-13: Отправка запроса на создание отчёта
**Актор:** Пользователь  
**Предусловие:** Пользователь авторизован и имеет право отправлять запросы
**Основной поток:**
1. Пользователь открывает раздел "Запросы на отчёты"
2. Нажимает "Создать запрос"
3. Заполняет форму:
   - Название запроса (обязательно)
   - Описание (детализация требований, поля, фильтры и т. д.)
   - Прикрепляет примеры данных (опционально)
4. Нажимает кнопку "Отправить запрос"
5. Система проверяет заполненность обязательных полей
6. Запрос отправляется в очередь на рассмотрение аналитикам/администраторам

**Альтернативный поток**
1. При пустом описании отчёта система не даёт отправить запрос и просит заполнить поле описания отчёта
**Постусловие:** Запрос создан и доступен в списке на рассмотрении.

#### UC-14: Обработка запроса на создание отчёта
**Актор:** Аналитик  
**Предусловие:** Есть необработанные запросы, аналитик имеет права на создание отчётов
**Основной поток:**
1. Аналитик открывает раздел "Запросы на отчёты"
2. Выбирает запрос из списка и нажимает "Обработать"
3. Система открывает интерфейс конструктора отчётов с предзаполненными данными из запроса
4. Аналитик создаёт отчёт и сохраняет его
5. Система автоматически назначает доступ пользователю-инициатору (минимум на чтение)
6. Система уведомляет пользователя о готовности отчёта
**Постусловие:** Отчёт создан, доступ предоставлен, запрос помечен как выполненный.

---

### 7. Администрирование системы

#### UC-15: Настройка очереди запросов
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает раздел "Настройки системы" → "Очередь запросов"
2. Устанавливает параметры:
   - Максимальное количество одновременных запросов на БД
   - Приоритеты для разных ролей (например, "Администраторы → Высокий", "Пользователи → Средний")
3. Нажимает "Сохранить"
4. Система применяет новые настройки
**Постусловие:** Очередь запросов работает согласно обновлённым правилам.

---

### 8. Подключения к БД

#### UC-16: Создание подключения
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает раздел подключений к БД
2. Нажимает "Добавить подключение".
3. Заполняет параметры:
   - Название подключения (уникальное)
   - Тип БД (выбирает из списка: PostgreSQL, MySQL, Oracle и т. д.)
   - Порт подключения
   - Хост подключения
   - Имя базы данных
   - Логин
   - Пароль
4. Нажимает "Проверить подключение"
5. Система тестирует соединение с БД
6. Если подключение успешно, администратор сохраняет настройки

**Альтернативный поток**
1. Если подключение не удалось, система выводит ошибку (например, "Неверные учетные данные")
**Постусловие:** Новое подключение добавлено в систему и доступно для использования в отчётах

## Диаграммы последовательностей системы отчётов

### 1. Вход в систему

@startuml

actor "Пользователь (USER, ANALYST,ADMIN)" as user
box  "Сайт" #AliceBlue
  participant "UI" as UI
end box

box "Сервис авторизации" #LightGreen
  participant "AuthService" as Auth
end box

box "БД" #00856f
  database "Таблица users" as DB
end box

group <b>1.</b> Вход через email и пароль
  user -> UI : Вводит email и пароль
  activate user
  activate UI
  
    UI -> Auth : POST /auth/login {email, password}
  activate Auth
  Auth -> Auth : Валидность email ('@company.com')
  alt Некорпоративный email
    Auth --> UI : 403 Forbidden\n«Доступ разрешён только с корпоративного email»
    UI --> user : Показать ошибку
    deactivate Auth
    deactivate UI
    deactivate user
  else Корпоративный email
    Auth -> DB : Поиск пользователя по email
    activate DB

    alt Пользователь не найден
      DB --> Auth : null
      deactivate DB
      Auth --> UI : 401 Unauthorized\n«Пользователь не найден»
      UI --> user : Показать ошибку
      deactivate Auth
      deactivate UI
      deactivate user
    else Пользователь найден
      DB --> Auth : user
      Auth -> Auth : Проверка хэша пароля

      alt Неверный пароль
        Auth --> UI : 401 Unauthorized\n«Неверный пароль»
        UI --> user : Показать ошибку
        deactivate Auth
        deactivate UI
        deactivate user
      else Пароль верный
        Auth -> DB : Обновление is_active = true
        Auth -> Auth : Генерация JWT (user_id, role)
        Auth --> UI : JWT токен
        deactivate Auth

        UI -> UI : Сохранение токена
        UI --> user : Перенаправление на главную страницу
        deactivate UI
        deactivate user
      end
    end
  end

end group


group <b>2.</b> Вход через OAuth (например, Яндекс)

  user -> UI : Нажимает "Войти через Яндекс"
  activate user
  UI -> UI : Инициировать OAuth

  note over UI : OAuth-провайдер возвращает email и access_token

  UI -> Auth : POST /auth/login {email, access_token}
  activate Auth

  Auth -> Auth : Валидность email ('@company.com')
  alt Некорпоративный email
    Auth --> UI : 403 Forbidden\n«Доступ разрешён только с корпоративного email»
    UI --> user : Показать ошибку
    deactivate Auth
    deactivate UI
    deactivate user
  else Корпоративный email
    Auth -> DB : Поиск пользователя по email
    activate DB

    alt Пользователь не найден
      DB --> Auth : null
      deactivate DB
      Auth --> UI : 401 Unauthorized\n«Пользователь не найден»
      UI --> user : Показать ошибку
      deactivate Auth
      deactivate UI
      deactivate user
    else Пользователь найден
      DB --> Auth : user
      Auth -> DB : Обновление is_active = true
      Auth -> Auth : Генерация JWT (user_id, role)
      Auth --> UI : JWT токен
      deactivate Auth

      UI -> UI : Сохранение токена
      UI --> user : Перенаправление на главную страницу
      deactivate UI
      deactivate user
    end
  end

end group

@enduml

### 2. Регистрация

@startuml

title Регистрация
actor "Администратор" as admin

box  "Сайт" #AliceBlue   
   participant "UI" as UI 
end box  

box "Сервис авторизации" #LightGreen   
   participant "AuthService" as Auth 
end box  

box "БД" #00856f
   database "Таблица users" as DB 
end box 

group <b>1.</b> Регистрация нового пользователя

  admin -> UI : Переходит на страницу регистрации
  activate admin
  activate UI

  UI --> admin : Отображает форму регистрации (email, имя пользователя, пароль, подтверждение пароля, роль)

  admin -> UI : Вводит данные пользователя
  UI -> Auth : POST /auth/register {email, name, password, confirmPassword, role}
  activate Auth

  Auth -> Auth : Валидность email ('@company.com') 

  alt Некорпоративный email
    Auth --> UI : 403 Forbidden\n«Доступ разрешён только с корпоративного email»
    UI --> admin : Показать ошибку, предложить изменить email
    deactivate Auth
    deactivate UI
    deactivate admin
  else Корпоративный email
    Auth -> DB : Поиск пользователя по email 
    activate DB

    alt Email уже используется
      DB --> Auth : найден пользователь
      Auth --> UI : 409 Conflict\n«Email уже зарегистрирован»
      UI --> admin : Показать ошибку, предложить изменить email
      deactivate DB
      deactivate Auth
      deactivate UI
      deactivate admin
    else Email уникален
      DB --> Auth : null
      deactivate DB

      Auth -> Auth : Проверка сложности пароля и совпадения confirmPassword

      alt Пароль не соответствует требованиям
        Auth --> UI : 400 Bad Request\n«Слабый пароль или не совпадает подтверждение»
        UI --> admin : Показать ошибку, предложить изменить пароль
        deactivate Auth
        deactivate UI
        deactivate admin
      else Все проверки пройдены
        Auth -> DB : Добавление учетной записи пользователя
        Auth --> UI : 201 Created\n«Пользователь успешно зарегистрирован»
        deactivate Auth

        UI --> admin : Подтверждение успешной регистрации
        deactivate UI
        deactivate admin
      end
    end
  end

end group

@enduml

### 3. Выход из системы

@startuml

title Выход из системы

actor "Пользователь (USER, ANALYST, ADMIN)" as user
box  "Сайт" #AliceBlue
   participant "UI" as UI 
end box  
box "Сервис авторизации" #LightGreen   
   participant "AuthService" as Auth 
end box  
box "БД" #00856f   
   database "Таблица users" as DB 
end box 

group <b>1.</b> Выход из системы

  user -> UI : Нажимает "Выход"
  activate user
  activate UI

  UI -> Auth : POST /auth/logout\nAuthorization: Bearer <JWT>
  activate Auth

  Auth -> Auth : Извлечь user_id из JWT
  Auth -> DB : SELECT * FROM users WHERE id = user_id
  activate DB
  DB --> Auth : Пользователь найден
  deactivate DB

  Auth -> DB : UPDATE users SET is_active = false WHERE id = user_id
  Auth --> UI : 200 OK
  deactivate Auth

  UI -> UI : Удаляет токен из хранилища
  UI --> user : Перенаправление на страницу входа
  deactivate UI
  deactivate user

end group


@enduml

### 4. Назначение ролей

@startuml

title Назначение ролей

actor "Администратор" as admin

box "Сайт" #AliceBlue
  participant "UI" as UI
end box

box "Backend" #LightGreen 
  participant "Backend" as BE
  database "БД пользователей" as DB
end box

box "БД" #00856f  
   database "Таблица users" as DB 
end box 

group <b>1.</b> Загрузка списка пользователей
  admin -> UI : Открывает страницу управления пользователями
  activate admin
  activate UI

  UI -> BE : GET /users
  activate BE
  BE -> DB : SELECT * FROM users
  activate DB
  DB --> BE : Список пользователей
  deactivate DB

  BE --> UI : JSON со списком пользователей
  deactivate BE

  UI -> admin : Отображает список пользователей
  deactivate UI
  deactivate admin
end group

group <b>2.</b> Назначение роли
  admin -> UI : Выбирает пользователя из списка и роль(из списка), нажимает «Сохранить изменения»
  activate admin
  activate UI

  UI -> BE : PATCH /users/{id}/role\n{ "role": "ANALYST" }
  activate BE

  BE -> DB : SELECT * FROM users WHERE id = {id}
  activate DB
  DB --> BE : Пользователь найден

  BE -> DB : UPDATE users SET role = 'ANALYST' WHERE id = {id}
  deactivate DB

  BE --> UI : 200 OK, "Роль успешно обновлена"
  deactivate BE

  UI -> admin : Показывает сообщение об успехе, обновляет UI
  deactivate UI
  deactivate admin
end group


@enduml

### 5. Просмотр пользователей

@startuml

title Просмотр списка пользователей с фильтрацией
actor "Администратор" as admin

box "Сайт" #AliceBlue
  participant "UI" as UI
end box

box "Backend" #LightGreen 
  participant "Backend" as BE
  database "БД пользователей" as DB
end box

box "БД" #00856f  
   database "Таблица users" as DB 
end box 

group <b>1.</b> Загрузка списка пользователей
  admin -> UI : Открывает страницу управления пользователями
  activate admin
  activate UI

  UI -> BE : GET /users
  activate BE
  BE -> DB : SELECT * FROM users
  activate DB
  DB --> BE : Список пользователей
  deactivate DB

  BE --> UI : JSON со списком пользователей
  deactivate BE

  UI -> admin : Отображает список пользователей
  deactivate UI
  deactivate admin
end group

group <b>2.</b> Фильтрация по ролям
  admin -> UI : Выбирает роль в фильтре (USER, ANALYST, ADMIN)
  activate admin
  activate UI

  UI -> BE : GET /users?role= роль
  activate BE
  BE -> DB : SELECT * FROM users WHERE role = 'роль'
  activate DB
  DB --> BE : Список пользователей с выбранной ролью
  deactivate DB

  BE --> UI : JSON с отфильтрованным списком
  deactivate BE

  UI -> admin : Отображает отфильтрованных пользователей
  deactivate UI
  deactivate admin
end group


@enduml

### 6. Создание отчёта

@startuml

title Создание отчётов

actor "Аналитик/Администратор" as user

box "Сайт" #AliceBlue
  participant "UI" as UI
end box

box "Backend" #LightSteelBlue
  participant "Backend" as BE
end box

box "БД" #LightGreen
  database "Таблица database_connection" as DBC
  database "Таблица reports" as ReportsDB
  database "Таблица report_parameters" as ParamsDB
end box
== 1. Получение списка подключенных БД ==
user -> UI: Открывает страницу создания отчета
activate user
activate UI

UI -> BE: GET /db-connections
activate BE

BE -> DBC: SELECT * FROM database_connections
activate DBC
DBC --> BE: Список подключений
deactivate DBC

BE --> UI: JSON со списком подключений
deactivate BE

UI -> user: Отображает форму и список БД
deactivate UI
deactivate user

== 2. Заполнение и отправка формы отчета ==
user -> UI: Вводит название, SQL, параметры, выбирает БД
activate user
activate UI

UI -> BE: POST /reports {name, sql, db_id, params}
activate BE

BE -> BE: Валидация SQL (только SELECT)
alt Недопустимый SQL
  BE --> UI: 400 Bad Request \n"Недопустимый SQL-запрос"
  deactivate BE
  UI -> user: Показывает ошибку в SQL
  deactivate UI
  deactivate user
else SQL допустим
  BE -> BE: Валидация параметров
  alt Ошибка в параметрах
    BE --> UI: 400 Bad Request \n"Ошибка в параметрах запроса"
    deactivate BE
    UI -> user: Показывает ошибку параметров
    deactivate UI
    deactivate user
  else Параметры валидны
    BE -> ReportsDB: Проверка уникальности названия
    activate ReportsDB
    alt Название уже существует
      ReportsDB --> BE: Дубликат найден
      deactivate ReportsDB
      BE --> UI: 409 Conflict \n"Отчет с таким названием уже существует"
      deactivate BE
      UI -> user: Предложение изменить имя
      deactivate UI
      deactivate user
    else Название уникально
      ReportsDB --> BE: Нет дубликата
      BE -> BE: Генерация UUID
      BE -> ReportsDB: INSERT INTO reports
      ReportsDB --> BE: OK
      deactivate ReportsDB

      BE -> ParamsDB: INSERT INTO report_parameters (по report_id)
      ParamsDB --> BE: OK

      BE --> UI: 201 Created \n{report_uuid}
      deactivate BE
      UI -> user: Отображает сообщение об успехе
      deactivate UI
      deactivate user
    end
  end
end

@enduml
