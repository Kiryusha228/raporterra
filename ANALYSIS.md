# Анализ функциональных требований к ПО

## Варианты использования системы отчетов

### 1. Регистрация

#### UC-01: Регистрация в системе
**Актор:** Администратор  
**Предусловие:** -  
**Основной поток:**
1. Администратор переходит на страницу регистрации
2. Система отображает форму с полями (почта, имя пользователя, пароль, подтверждение пароля)
3. Администратор вводит данные пользователя
4. Система проверяет:
   - Соответствие формата email корпоративной почте
   - Уникальность email в системе
   - Сложность пароля
5. Система создаёт учётную запись пользователя

**Альтернативный поток:**
1. Если проверка данных неудачная, система предлагает ввести другие данные

**Постусловие:** Пользователь становится участником системы

---

### 2. Аутентификация и авторизация

#### UC-02: Вход в систему
**Актор:** Пользователь, Администратор, Аналитик  
**Предусловие:** Пользователь зарегистрирован в системе
##### Вход через email и пароль
**Основной поток:**
1. Пользователь открывает страницу входа и вводит email и пароль на страничке входа 
2. Фронтенд отправляет запрос на авторизацию POST /auth/login {email, password} в бекэнд
3. Сервис авторизации проверяет email:
   • Если email не оканчивается на @company.com, возвращается ошибка
4. Сервис авторизации проверяет пользователя по БД:
   • Ищет запись по email
   • Проверяет хэш пароля 
5. Если данные корректны бкэнд формирует JWT-токен, в который включается:
   • ID пользователя
   • Роль (USER, ANALYST, ADMIN)
6. Токен возвращается во фронтенд 
7. Фронтенд сохраняет токен 
8. Пользователь перенаправляется на главную страницу с доступом согласно своей роли 
##### Вход через OAuth-провайдера
**Основной поток:**
1. Пользователь нажимает «Войти через Яндекс(например)»
2. Фронтенд инициирует авторизацию через OAuth
3. После успешного входа, провайдер возвращает access_token и данные пользователя (email, имя и т.д.)
4. Фронтенд отправляет полученные данные POST /auth/login {email, access_token}в бэкенд 
5. Сервис авторизации проверяет email:
   • Должен заканчиваться на @company.com
6. Сервис авторизации проверяет пользователя по БД:
   • Ищет запись по email
7. Если данные корректны бкэнд формирует JWT-токен, в который включается:
   • ID пользователя
   • Роль (USER, ANALYST, ADMIN)
8. Токен возвращается во фронтенд 
9. Фронтенд сохраняет токен 
10. Пользователь перенаправляется на главную страницу с доступом согласно своей роли 

**Альтернативные поток:**
1) Некорпоративный email
1. Пользователь вводит email и пароль на странице входа.
2. Фронтенд отправляет запрос: POST /auth/login { email, password } 
3. Сервис авторизации:
   • Проверяет: email.endsWith('@company.com')
   • Условие не выполнено
4. Сервис автоизации не обращается к БД, сразу возвращает ошибку:
   • 403 Forbidden
   • Сообщение: "Доступ разрешён только с корпоративного email"
5. Фронтенд: показывает пользователю уведомление об ошибке 
2) Пользователь не найден (email корректный, но отсутствует в БД)
1. Пользователь вводит email и пароль
2. Фронтенд отправляет: POST /auth/login {email, password}
3. Сервис авторизации:
   • Проверяет email: @company.com
   • Обращается к БД: Результат: пустой
4. Бэкенд возвращает: 401 Unauthorized Сообщение: "Пользователь не найден"
5. Фронтенд: отображает сообщение об ошибке
3) Неверный пароль (email найден, но введён неверный пароль)
1. Пользователь вводит email и пароль
2. Фронтенд отправляет: POST /auth/login {email, password}
3. Сервис авторизации:
   • Проверяет email: @company.com
   • Выполняет запрос: находит пользователя
   • Сравнивает хэш пароля: условие не выполнено → пароль не совпадает
4. Бэкенд возвращает: 401 Unauthorized Сообщение: "Неверный пароль"
5. Фронтенд: показывает сообщение об ошибке

**Постусловие:** Пользователь получает доступ согласно своей роли

#### UC-03: Выход из системы
**Актор:** Пользователь, Администратор, Аналитик  
**Предусловие:** Пользователь вошёл в систему и имеет активный JWT-токен, сохранённый на клиенте  
**Основной поток:**
1. Пользователь нажимает «Выход» в пользовательском интерфейсе 
2. Фронтенд: отправляет запрос POST /auth/logout с заголовком Authorization: Bearer <JWT> на бэкенд.
3. Бэкенд:
   • Извлекает user_id из JWT.
   • Обращается к базе данных и находит пользователя по user_id.
   • Обновляет флаг: is_active = false
4. Бэкенд возвращает ответ 200 OK.
5. Фронтенд: 
   • Удаляет токен из хранилища.
   • Перенаправляет пользователя на страницу входа

---

### 3. Управление пользователями

#### UC-04: Назначение ролей
**Актор:** Администратор  
**Предусловие:** Пользователь существует в системе  
**Основной поток:**
1. Администратор открывает страницу управления пользователями 
2. Фронтенд отправляет запрос GET/users для загрузки списка пользователей
3. Бэкенд делает запрос к БД и возвращает список пользователей
4. Фронтенд отображает список
5. Администратор выбрает нужного пользователя и новую роль через представленную форму, нажимает кнопочку «Сохранить изменения»
6. Фронтенд отправляет запрос на изменение роли
7. Бэкенд: 
   • Проверяет существует ли такой пользователь 
   • Обновляет запись в БД
8. Бэкенд возвращает 200 OK, сообщение: «Роль успешно обновлена»
9. Фронтенд отображает уведомление об успешном изменении и обновляет UI

Валидация не нужна. У каждой роли пользователя свои возможности, следовательно и UI тоже, таким образом, никто кроме администратора не сможет выполнять его запросы. Выбор самой роли будет реализован через выпадающий список, следовательно, администратору не нужно вводить данные вручную, что снимает вопрос валидации.

#### UC-05: Просмотр списка пользователей
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает страницу управления пользователями 
2. Фронтенд отправляет запрос GET/users для загрузки списка пользователей
3.  Бэкенд делает запрос к БД и возвращает список пользователей
4. Фронтенд отображает список
5. Администратор выбирает фильтрацию по роли (роль из выпадающего списка)
6. Фронтенд отправляет запрос GET /users?role=… (например. ANALYST) для загрузки списка пользователей
7. Бэкенд делает запрос к БД с фильтром по роли и возвращает список пользователей
8. Фронтенд отображает отфильтрованный список 
тут по валидации тоже не вижу смысла ничего делать так как выбор из выпадающего списка, так же как и проверку роли (что запрос делает администратор)

#### UC-06: Создание групп пользователей
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает раздел "Группы пользователей"
2. Нажимает кнопку "Создать группу пользователей"
3. Система отображает форму создания группы
4. Администратор заполняет поля:
   - Название группы
   - Описание группы
5. Нажимает кнопку "Создать"
6. Система создаёт новую группу

#### UC-07: Добавление пользователей в группу
**Актор:** Администратор
**Предусловия:** 
   - Пользователь и группа существуют в системе
   - У текущего пользователя есть права на управление группами
   - Пользователь не состоит в данной группе  
**Основной поток:**
1. Администратор выбирает раздел "Группы пользователей"
2. Система отображает список всех групп с возможностью поиска
3. Администратор нажимает на конкретную группу
4. Система показывает:
   - Текущий состав группы
   - Кнопку "Добавить пользователей"
5. Администратор нажимает "Добавить пользователей"
6. Система открывает модальное окно с:
   - Поисковой строкой по email/имени
   - Списком доступных пользователей
   - Чекбоксами для выбора
7. Администратор выбирает одного или нескольких пользователей
8. Нажимает кнопку "Подтвердить"
9. Система проверяет, что пользователи не дублируются в группе
10. Добавляет выбранных пользователей в группу
11. Система обновляет состав группы
12. Показывает уведомление: "Пользователи успешно добавлены"

**Альтернативный поток:**
1. При попытке добавить пользователя, уже находящегося в группе, система показывает соответствующее предупреждение и не даёт повторно добавить пользователя

---

### 4. Работа с отчётами

#### UC-08: Создание отчёта
**Актор:** Аналитик, Администратор  
**Основной поток:**
1. Пользователь открывает страничку создания отчета в интерфейсе 
2. Фронтенд отправляет GET-запрос на получение подключенных БД
3. Бэкенд получает список подключений из таблицы database_connections и возвращает его (список имён БД)
4. Фронтенд отображает список (при выборе целевой БД)
5. Пользователь вводит: 
   • Название отчета 
   • SQL-запрос (только SELECT)
   • Целевая БД (из списка) подключений
   • Параметры
6. Фронтенд отправляет POST-запрос POST/reports
7. Бэкенд выполняет валидацию: 
   • Проверка, что SQL содержит только SELECT-запрос (read-only)
   • Проверка корректности параметров
8. Если все проверки успешны:
   • Бэкенд генерирует UUID
   • Формирует объект отчета
   • Сохраняет в таблицу reports
9. Бэкенд возвращает 201 Created и JSON с UUID отчета.
10. Фронтенд уведомляет пользователя: «Отчет успешно создан».
**Альтернативные потоки:** 
1)  Невалидный SQL-запрос
1. Пользователь вводит SQL-запрос, содержащий недопустимые конструкции (например, UPDATE, DELETE, INSERT).
2. Фронтенд отправляет: POST /reports.
3. Бэкенд проверяет SQL: запрос не проходит валидацию (например, не начинается с SELECT).
4. Бэкенд возвращает: 400 Bad Request Сообщение: «Недопустимый SQL-запрос. Допускаются только SELECT-запросы»
5. Фронтенд: уведомляет пользователя об ошибке в SQL.
2) Ошибка в параметрах
1. Пользователь добавляет параметры (например, start_date, end_date), но забывает обязательные поля или указывает некорректные типы.
2. Фронтенд отправляет: POST /reports.
3. Бэкенд проверяет параметры: отсутствуют обязательные поля, либо типы не соответствуют (например, start_date: «abc»).
4. Бэкенд возвращает: 400 Bad Request Сообщение: «Ошибка в параметрах запроса»
5. Фронтенд: выводит сообщение пользователю.
3) Отчёт с таким названием уже существует 
1. Пользователь создает отчет с названием, которое уже существует (например, для уникального имени внутри одной коллекции или владельца).
2. Фронтенд отправляет: POST /reports.
3. Бэкенд:
   • Проверяет имя отчета по условию уникальности
   • Находит дубликат
4. Бэкенд возвращает: 409 Conflict Сообщение: «Отчет с таким названием уже существует»
5. Фронтенд: предлагает пользователю изменить имя отчета.

#### UC-09: Выполнение отчёта
**Актор:** Пользователь  
**Предусловия:**
   - Пользователь авторизован в системе
   - У пользователя есть доступ хотя бы к одному отчёту
**Основной поток:**
1. Пользователь открывает раздел "Отчёты"
2. Система отображает список доступных отчётов (с фильтрами по категориям/коллекциям, если применимо)
3. Пользователь выбирает нужный отчёт
4. Пользователь нажимает кнопку "Сформировать отчёт"
5. Система проверяет доступность БД:
   - Если БД свободна – немедленно запускает выполнение
   - Если БД перегружена – ставит запрос в очередь и уведомляет пользователя ("Отчёт поставлен в очередь")
6. Система выполняет запрос к БД
6. При успешном выполнении возвращает результат в виде таблицы или графика

**Альтернативные потоки:**
1) Превышение времени выполнения (таймаут)
1. При превышении 5 минут выполнения система отменяет запрос
2. Пользователь получает уведомление: "Превышено время выполнения. Попробуйте повторить позже"
2) Ошибка доступа к БД
1. Если БД недоступна (нет соединения, ошибка аутентификации):
   - Система выводит сообщение: "База данных временно недоступна. Обратитесь к администратору"
   - Запрос не ставится в очередь
**Постусловие:** Отчёт сформирован и отображён пользователю

#### UC-10: Выгрузка в Excel
**Актор:** Пользователь  
**Предусловие:** Пользователь сформировал отчёт и находится на странице его просмотра
**Основной поток:**
1. Пользователь нажимает кнопку "Экспорт в Excel"
2. Система генерирует файл в формате .xlsx на основе данных отчёта
3. Система предоставляет пользователю ссылку для скачивания файла
**Постусловие:** Файл успешно сохранён на устройстве пользователя.

---

### 5. Управление коллекциями

#### UC-11: Создание коллекции
**Актор:** Аналитик, Администратор  
**Предусловие:** Пользователь авторизован и имеет права на создание коллекций.
**Основной поток:**
1. Пользователь переходит в раздел "Коллекции"
2. Нажимает кнопку "Создать коллекцию"
3. Вводит название коллекции (обязательно) и описание (опционально)
4. Система проверяет уникальность названия (в рамках текущего уровня вложенности)
5. Система создаёт коллекцию
6. Пользователь выбирает отчёты из списка доступных и добавляет их в коллекцию
**Постусловие:** Коллекция создана и содержит выбранные отчёты.

#### UC-12: Назначение доступа к коллекции
**Актор:** Администратор  
**Предусловие:** Коллекция существует, администратор имеет права на управление доступом.
**Основной поток:**
1. Администратор выбирает коллекцию в интерфейсе
2. Нажимает кнопку "Настроить доступ"
3. В открывшейся форме выбирает:
   - Тип доступа (индивидуальный / групповой)
   - Пользователей или группы из списка
   - Уровень доступа (чтение, редактирование, полный доступ)
4. Система сохраняет настройки доступа
**Постусловие:** Пользователи/группы получили указанный уровень доступа к коллекции.

---

### 6. Запросы на создание отчетов

#### UC-13: Отправка запроса на создание отчёта
**Актор:** Пользователь  
**Предусловие:** Пользователь авторизован и имеет право отправлять запросы
**Основной поток:**
1. Пользователь открывает раздел "Запросы на отчёты"
2. Нажимает "Создать запрос"
3. Заполняет форму:
   - Название запроса (обязательно)
   - Описание (детализация требований, поля, фильтры и т. д.)
   - Прикрепляет примеры данных (опционально)
4. Нажимает кнопку "Отправить запрос"
5. Система проверяет заполненность обязательных полей
6. Запрос отправляется в очередь на рассмотрение аналитикам/администраторам

**Альтернативный поток**
1. При пустом описании отчёта система не даёт отправить запрос и просит заполнить поле описания отчёта
**Постусловие:** Запрос создан и доступен в списке на рассмотрении.

#### UC-14: Обработка запроса на создание отчёта
**Актор:** Аналитик  
**Предусловие:** Есть необработанные запросы, аналитик имеет права на создание отчётов
**Основной поток:**
1. Аналитик открывает раздел "Запросы на отчёты"
2. Выбирает запрос из списка и нажимает "Обработать"
3. Система открывает интерфейс конструктора отчётов с предзаполненными данными из запроса
4. Аналитик создаёт отчёт и сохраняет его
5. Система автоматически назначает доступ пользователю-инициатору (минимум на чтение)
6. Система уведомляет пользователя о готовности отчёта
**Постусловие:** Отчёт создан, доступ предоставлен, запрос помечен как выполненный.

---

### 7. Администрирование системы

#### UC-15: Настройка очереди запросов
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает раздел "Настройки системы" → "Очередь запросов"
2. Устанавливает параметры:
   - Максимальное количество одновременных запросов на БД
   - Приоритеты для разных ролей (например, "Администраторы → Высокий", "Пользователи → Средний")
3. Нажимает "Сохранить"
4. Система применяет новые настройки
**Постусловие:** Очередь запросов работает согласно обновлённым правилам.

---

### 8. Подключения к БД

#### UC-16: Создание подключения
**Актор:** Администратор  
**Основной поток:**
1. Администратор открывает раздел подключений к БД
2. Нажимает "Добавить подключение".
3. Заполняет параметры:
   - Название подключения (уникальное)
   - Тип БД (выбирает из списка: PostgreSQL, MySQL, Oracle и т. д.)
   - Порт подключения
   - Хост подключения
   - Имя базы данных
   - Логин
   - Пароль
4. Нажимает "Проверить подключение"
5. Система тестирует соединение с БД
6. Если подключение успешно, администратор сохраняет настройки

**Альтернативный поток**
1. Если подключение не удалось, система выводит ошибку (например, "Неверные учетные данные")
**Постусловие:** Новое подключение добавлено в систему и доступно для использования в отчётах