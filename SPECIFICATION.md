# Спецификация требований к системе

## 1. Введение 

### Цель
Разработка веб-сервиса для выполнения SQL-отчетов с разграничением доступа и управлением очередью запросов

### Соглашения о терминах
Отчёт - SQL-запрос 
Коллекция - группа отчётов с общими правами доступа

### Аудитория проекта
1. Разработчики (основная аудитория)
2. Бизнес-аналитики
3. Технические руководители
4. Тестировщики

### Масштаб проекта
• Сервис авторизации + основной сервис отчётов
• Поддержка 3+ СУБД: PostgreSQL, MySQL, Oracle
• До 500 одновременных пользователей

## 2. Общее описание

### Видение продукта
Веб-сервис с разграничением функциональности в зависимости от типа пользователя: пользователь, администратор (и nice to have: аналитик) для создания SQL-отчётов с:
• Механизмом планирования выполнения
• Гибкой системой распределения прав
Уровни доступа и роли хранятся в базе данных сервиса.

### Функциональность продукта
1. Управление пользователями (CRUD + роли)
2. Работа с отчётами (создание/выполнение/экспорт)
3. Управление доступом (индивидуальный/групповой)
4. Очередь запросов с приоритезацией

### Классы и характеристики пользователей
1. Обычные пользователи (все пользователи после регистрации):
    • Просмотр списка доступных ему отчетов
    • Просмотр отчета в веб-интерфейсе
    • Выгрузка отчета в формате Excel
2. Аналитики:
    • Создание/редактирование отчётов
    • Настройка визуализации
3. Администраторы:
    • Управление пользователями:
        - Регистрация
        - Назначение ролей доступа
        - Назначение отчетов конкретным пользователям
    • Создание SQL-отчетов

### Среда функционирования продукта
• Сервер: Docker-контейнер
• БД: PostgreSQL (для обоих сервисов)
• Клиент: Яндекс/Chrome последних версий

### Рамки, ограничения, правила
1. Только SELECT-запросы к БД
2. Поддержка только корпоративных email
3. Макс. размер результата - 100 000 строк

### Стек технологий
База данных сервиса: PostgreSQL
Бэкенд: Java/Kotlin, Spring 3+, Gradle
Фронтенд: Angular, Taiga UI

## 3. Функциональность системы

### Сервис авторизации/аутентификации

Каждому пользователю присваивается уникальный числовой идентификатор (ID). Роли пользователей определяются и управляются через базу данных.

1) Ограничение по домену:
    - Разрешены только email с доменами @company.com
    - При попытке регистрации с некорпоративным email возвращается ошибка 403 Forbidden с сообщением: "Доступ разрешен только для корпоративных email"

2) Ролевая модель:
    - USER: выполнение отчетов
    - ANALYST: создание отчетов + функциональность USER
    - ADMIN: управление пользователями + полный доступ

3) OAuth2-провайдеры: Яндекс

### Сервис работы с отчётами

Отчет представляет собой SQL-запрос, привязанный к конкретной базе данных.
У каждого отчета — уникальный UUID. Сервис поддерживает подключение к произвольным базам данных с любыми структурами таблиц

1) Создание отчёта
• Ограничения:
    - Максимальная длина SQL-запроса: 10 000 символов
    - Запрещённые ключевые слова: INSERT, UPDATE, DELETE, DROP, GRANT
    - Автоматическая проверка синтаксиса 

2) Выполнение отчёта
• Очередь запросов:
    - Приоритеты: ADMIN (высокий), ANALYST (средний), USER (низкий)
    - Максимум 1 активный запрос на базу данных
• Ограничения выполнения:
    - Таймаут: 5 минут
• Состояние успешного завершения
    - Таблица данных:
        Сортировка по столбцам
        Поиск по столбцам

### Управление пользователями

**Назначение ролей пользователям**
1. Система фильтрации:
    - Поиск по email/имени (дебаунс 300мс)
    - Фильтр по ролям (выпадающий список)
2. Валидация:
    - Запрет на изменение собственной роли
    - Проверка прав текущего пользователя (только ADMIN может изменять роли)
3. Сортировка по колонкам

**Назначение отчётов пользователям/группам**
1. Основная информация:
    - Название отчёта
    - Владелец отчёта
    - Дата создания
2. Таблица доступа:
    - Список пользователей/групп с доступом
    - Типы прав (чтение, редактирование, полный доступ)
3. Система добавления доступа:
    - Поиск пользователей/групп
    - Выбор уровня доступа
4. Валидация:
    - Проверка уникальности пользователя в списке доступа
    - Предупреждение при понижении прав владельца
5. API-интеграция. Эндпоинты:
    - GET /api/users - список пользователей
    - PATCH /api/users/{id}/role - изменение роли
    - GET /api/reports/{id}/access - права доступа
    - POST /api/reports/{id}/access - обновление прав

### Управление коллекциями
2. Управление доступом:
    - Наследование прав от родительских коллекций

### Администрирование
1. Очередь запросов:
    - Реалтайм-мониторинг активных запросов
2. Подключения к БД:
    - Тестирование соединения без сохранения
    - Маскирование паролей
    - Указание статуса подключений

## 4. Требования к внешним интерфейсам

### Пользовательские интерфейсы
### • Сервис авторизации/аутентификации

1. Форма входа:
    - Поля: Email, Password
    - Кнопки: "Войти", "Войти через Яндекс"
2. Форма регистрации:
    - Поля: Email, Username, Password
    - Кнопки: "Зарегистрироваться"
    - Валидация в реальном времени - Подсветка некорпоративного email
3. Общие: 
    - Визуальное выделение невалидных полей
    - Toast-уведомления для ошибок сервера (401, 403)

### • Сервис работы с отчётами

1. Форма создания отчёта
| Поле           | Тип    | Обязательное | Валидация                  |
|----------------|--------|--------------|----------------------------|
| name           | String | Да	         | Уникальное                 |
| description    | String | Нет          | До 5000 символов           |
| sql_query      | String |	Да           | Только SELECT              |
| connection_id  | Long   | Да           | Существующий connection_id |
Также присутствуют кнопки "Создать отчёт", "Отменить"

2. Форма выполнения отчёта
• Шапка отчёта
| Элемент         | Описание                                                                  |
|-----------------|---------------------------------------------------------------------------|
| Название отчёта | Отображается данное отчёту при создании название                          |
| Описание        | Текстовая сводка под названием (макс. 3 строки, с возможностью раскрытия) |
| Иконка статуса  |	◷ (в очереди), ▶ (выполняется), ✓ (готово), ✗ (ошибка)                  |
| Информация о БД | Имя подключения + иконка типа БД (PostgreSQL/MySQL/Oracle)                |

• Кнопки действий
| Кнопка            | Поведение                                                                             |
|-------------------|---------------------------------------------------------------------------------------|
| "Выполнить"       | Отправка запроса, переход в статус "В очереди"                                        |
| "Экспорт в Excel" | Запуск процесса создания XLSX-файла с именем <Название отчёта>_<Дата выполнения>.xlsx |
При отображении результата должна присутствовать пагинация (100 строк на страницу)

### • Управление пользователями

1. Таблица пользователей:
    - Сортировка по колонкам
    - Фильтры по ролям
    - Пагинация (100 строк на страницу)
2. Формы редактирования:
    - Модальные окна для создания/редактирования
    - Выпадающие списки для выбора ролей
3. Группы пользователей:
    - Мультиселект для добавления пользователей
    - Чекбоксы для массовых операций
    - Drag-and-drop интерфейс (nice to have)

**Назначение ролей пользователям**

1. Таблица пользователей с колонками:
    - Email пользователя
    - Имя
    - Текущая роль
    - Кнопка "Изменить роль"
2. Система фильтрации:
    - Поиск по email/имени (дебаунс 300мс)
    - Фильтр по ролям (выпадающий список)
3. Модальное окно изменения роли:
    - Открывается по кнопке "Изменить роль"
    - Содержит:
        • Текущую роль пользователя
        • Выпадающий список доступных ролей (USER, ANALYST, ADMIN)
        • Кнопки "Сохранить" и "Отмена"
4. Валидация:
    - Запрет на изменение собственной роли
    - Проверка прав текущего пользователя (только ADMIN может изменять роли)

**Назначение отчётов пользователям/группам**

1. Основная информация:
    - Название отчёта
    - Владелец отчёта
    - Дата создания
2. Таблица доступа:
    - Список пользователей/групп с доступом
    - Типы прав (чтение, редактирование, полный доступ)
3. Система добавления доступа:
    - Модальное окно "Предоставить доступ"
    - Поиск пользователей/групп
    - Выбор уровня доступа
    - Кнопка "Добавить"
4. Валидация:
    - Проверка уникальности пользователя в списке доступа
    - Предупреждение при понижении прав владельца
5. API-интеграция. Эндпоинты:
    - GET /api/users - список пользователей
    - PATCH /api/users/{id}/role - изменение роли
    - GET /api/reports/{id}/access - права доступа
    - POST /api/reports/{id}/access - обновление прав

### • Управление коллекциями

1. Древовидный интерфейс:
    - Вложенные коллекции с возможностью сворачивания
    - Drag-and-drop перемещение отчётов (nice to have)
2. Управление доступом:
    - Матрица прав (пользователи × уровни доступа)

### • Администрирование

1. Очередь запросов:
    - Реалтайм-мониторинг активных запросов
    - Визуализация приоритетов (цветовая кодировка)
2. Подключения к БД:
    - Маскирование паролей
    - Индикация статуса подключений

### Программные интерфейсы

1. API работы с отчётами
Компоненты:
1) Пакет controller
  • ReportController.java - управление отчётами (CRUD + выполнение)
  • CollectionController.java - работа с коллекциями
  • DatabaseConnectionController.java - подключения к БД
  • UserInfoController.java - информация о пользователях
  • GroupController.java - управление группами пользователей
2)  Пакет service
  • CollectionService.java - логика работы с коллекциями
  • DatabaseConnectionService.java - управление подключениями к БД
  • GroupService.java - логика управления группами пользователей
  • ReportQueueService.java - очередь выполнения отчётов
  • ReportService.java - логика управления отчётами
  • UserInfoService.java - формирование информации о пользователях
3) Пакет repository
JPA-репозитории для всех сущностей:
  • CollectionAccessRepository.java
  • CollectionReportRepository.java
  • CollectionRepository.java
  • DatabaseConnectionRepository.java
  • GroupRepository.java
  • ReportQueueRepository.java
  • ReportRepository.java
  • UserGroupRepository.java
  • UserInfoRepository.java
4) Пакет model
  • Entity:
  Все сущности из БД + отдельно вынесенные в сущности компоненты в Java-классах:
    collection:
      - Collection.java
      - CollectionAccess.java
      - CollectionReport.java
      - CollectionReportId.java
    dbconnection:
      - DatabaseConnection.java
    group:
      - Group.java
    report:
      - Report.java
      - ReportQueue.java
      - TaskStatus.java
    user:
      - Role.java
      - UserInfo.java
    usergroup:
      - UserGroup.java
      - UserGroupId.java
  • DTO:
    collection:
      - CollectionDto.java
      - CreateCollectionDto.java
      - UpdateCollectionDto.java
    connection:
      - CreateDatabaseConnectionDto.java
      - DatabaseConnectionDto.java
      - FullDatabaseConnectionDto.java
    exception:
      - ExceptionDto.java
    group
      - CreateGroupDto.java
      - GroupDto.java
      - UpdateGroupDto.java
    report:
      - AvailableReportsDto.java
      - CreateReportDto.java
      - ReportMetadataDto.java
      - ReportQueueResultDto.java
      - UpdateReportDto.java
    user:
      - CreateUserInfoDto.java
5) Пакет config
  • SecurityConfig.java - настройка Spring Security + JWT
  • JdbcConfig.java - конфигурация источников данных
  • SwaggerConfig.java - документация API
  • JwtFilter.java - фильтр аутентификации
  • JwtService.java - настройка JWT
6) Пакет exception
  • Специализированные исключения:
    - GlobalExceptionHandler.java - централизованный класс-обработчик
    - CollectionAccessDeniedException.java
    - CollectionNotFoundException.java
    - ConnectionNotFoundException.java
    - DatabaseConnectionNotFoundException.java
    - GroupNotFoundException.java
    - InvalidReportQueryException.java
    - ReportNotFoundException.java
    - UnsupportedDatabaseException.java
    - UserNotFoundException.java
7) Пакет component
  • Специальные компоненты:
    - ReportQueueWorker.java - фоновый обработчик очереди
    - ResultStorage.java - временное хранение результатов
8) Пакет mapper
  Классы для преобразований типов Entity ↔ DTO:
  • CollectionMapper.java
  • DatabaseConnectionMapper.java
  • GroupMapper.java
  • ReportMapper.java

Особенности реализации:
1) Очередь выполнения:
    - Приоритезация запросов
    - Ограничение параллельных запросов к БД
    - Механизм повтора при ошибках
2) Доступ к данным:
    - Проверка прав через @PreAuthorize
    - Наследование прав от коллекций
3) Обработка ошибок:
    - Специализированные исключения
    - Единый формат ответа

## 5. Нефункциональные требования

### Производительность

1. Время отклика API < 500 мс
2. Поддержка 50+ одновременных выполнений отчётов
3. Загрузка списка отчётов < 1 сек при 1000+ записях

### Качество ПО

1. Покрытие кода тестами > 80%
2. Статический анализ (SonarQube)
3. Тестирование безопасности (OWASP ZAP)