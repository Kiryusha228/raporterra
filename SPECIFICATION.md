# Спецификация требований к системе

## 1. Общие положения

### Цель
Разработка веб-сервиса для выполнения параметризованных SQL-отчетов с разграничением доступа и управлением очередью запросов

### Описание проекта
Разрабатывается веб-сервис с разграничением функциональности в зависимости от типа пользователя: пользователь, администратор (и nice to have: аналитик). Уровни доступа и роли хранятся в базе данных сервиса.

### Стек технологий
База данных сервиса: PostgreSQL
Бэкенд: Java/Kotlin, Spring 3+, Gradle
Фронтенд: Angular, Taiga UI

## 2. Функциональные требования

### Сервис авторизации/аутентификации

Каждому пользователю присваивается уникальный числовой идентификатор (ID). Роли пользователей определяются и управляются через базу данных.

1) Ограничение по домену:
    - Разрешены только email с доменами @company.com
    - При попытке регистрации с некорпоративным email возвращается ошибка 403 Forbidden с сообщением: "Доступ разрешен только для корпоративных email"

2) Ролевая модель:
    - USER: выполнение отчетов
    - ANALYST: создание отчетов + функциональность USER
    - ADMIN: управление пользователями + полный доступ

3) OAuth2-провайдеры: Яндекс

4) Требования к UI:
    • Форма входа:
    - Поля: Email, Password
    - Кнопки: "Войти", "Войти через Яндекс"
    • Форма регистрации:
    - Поля: Email, Username, Password
    - Кнопки: "Зарегистрироваться"
    - Валидация в реальном времени - Подсветка некорпоративного email
    Общие: 
        - Визуальное выделение невалидных полей
        - Toast-уведомления для ошибок сервера (401, 403)


### Сервис работы с отчётами

Отчет представляет собой SQL-запрос, привязанный к конкретной базе данных.
У каждого отчета — уникальный UUID. Сервис поддерживает подключение к произвольным базам данных с любыми структурами таблиц

1) Создание отчёта
• Поля формы:
| Поле           | Тип    | Обязательное | Валидация                  |
|----------------|--------|--------------|----------------------------|
| name           | String | Да	         | Уникальное                 |
| description    | String | Нет          | До 5000 символов           |
| sql_query      | String |	Да           | Только SELECT              |
| connection_id  | Long   | Да           | Существующий connection_id |
Также присутствуют кнопки "Создать отчёт", "Отменить"
• Ограничения:
    - Максимальная длина SQL-запроса: 10 000 символов
    - Запрещённые ключевые слова: INSERT, UPDATE, DELETE, DROP, GRANT
    - Автоматическая проверка синтаксиса 

2) Выполнение отчёта
• Очередь запросов:
    - Приоритеты: ADMIN (высокий), ANALYST (средний), USER (низкий)
    - Максимум 1 активный запрос на базу данных
• Ограничения выполнения:
    - Таймаут: 5 минут
• Форма выполнения отчёта
Шапка отчёта
| Элемент         | Описание                                                                  |
|-----------------|---------------------------------------------------------------------------|
| Название отчёта | Отображается данное отчёту при создании название                          |
| Описание        | Текстовая сводка под названием (макс. 3 строки, с возможностью раскрытия) |
| Иконка статуса  |	◷ (в очереди), ▶ (выполняется), ✓ (готово), ✗ (ошибка)                  |
| Информация о БД | Имя подключения + иконка типа БД (PostgreSQL/MySQL/Oracle)                |

Кнопки действий
| Кнопка            | Поведение                                                                             |
|-------------------|---------------------------------------------------------------------------------------|
| "Выполнить"       | Отправка запроса, переход в статус "В очереди"                                        |
| "Экспорт в Excel" | Запуск процесса создания XLSX-файла с именем <Название отчёта>_<Дата выполнения>.xlsx |

Состояние успешного завершения
    - Таблица данных:
        Сортировка по столбцам
        Поиск по столбцам

### Управление пользователями
1. Таблица пользователей:
    - Сортировка по колонкам
    - Фильтры по ролям
2. Формы редактирования:
    - Модальные окна для создания/редактирования
    - Выпадающие списки для выбора ролей
3. Группы пользователей:
    - Мультиселект для добавления пользователей
    - Чекбоксы для массовых операций
    - Drag-and-drop интерфейс (nice to have)

**Назначение ролей пользователям**
1. Таблица пользователей с колонками:
    - Email пользователя
    - Имя
    - Текущая роль
    - Кнопка "Изменить роль"
2. Система фильтрации:
    - Поиск по email/имени (дебаунс 300мс)
    - Фильтр по ролям (выпадающий список)
3. Модальное окно изменения роли:
    - Открывается по кнопке "Изменить роль"
    - Содержит:
        • Текущую роль пользователя
        • Выпадающий список доступных ролей (USER, ANALYST, ADMIN)
        • Кнопки "Сохранить" и "Отмена"
4. Валидация:
    - Запрет на изменение собственной роли
    - Проверка прав текущего пользователя (только ADMIN может изменять роли)

**Назначение отчётов пользователям/группам**
1. Основная информация:
    - Название отчёта
    - Владелец отчёта
    - Дата создания
2. Таблица доступа:
    - Список пользователей/групп с доступом
    - Типы прав (чтение, редактирование, полный доступ)
3. Система добавления доступа:
    - Модальное окно "Предоставить доступ"
    - Поиск пользователей/групп
    - Выбор уровня доступа
    - Кнопка "Добавить"
4. Валидация:
    - Проверка уникальности пользователя в списке доступа
    - Предупреждение при понижении прав владельца
5. API-интеграция. Эндпоинты:
    - GET /api/users - список пользователей
    - PATCH /api/users/{id}/role - изменение роли
    - GET /api/reports/{id}/access - права доступа
    - POST /api/reports/{id}/access - обновление прав
### Управление коллекциями
1. Древовидный интерфейс:
    - Вложенные коллекции с возможностью сворачивания
    - Drag-and-drop перемещение отчётов (nice to have)
2. Управление доступом:
    - Матрица прав (пользователи × уровни доступа)
    - Наследование прав от родительских коллекций

### Администрирование
1. Очередь запросов:
    - Реалтайм-мониторинг активных запросов
    - Визуализация приоритетов (цветовая кодировка)
    - Ручное управление очередью
2. Подключения к БД:
    - Тестирование соединения без сохранения
    - Маскирование паролей
    - Индикация статуса подключений

### Разграничение функциональности

• Функциональность администратора

    - Назначение ролей доступа пользователям
    - Создание новых SQL-отчетов
    - Назначение отчетов конкретным пользователям

• Функциональность пользователя

    - Просмотр списка доступных ему отчетов
    - Просмотр отчета в веб-интерфейсе
    - Выгрузка отчета в формате Excel

