## **Описание структуры базы данных**

## **1\. Таблица** `users` **(Пользователи)**

**Назначение**: Хранение учетных записей пользователей системы

**Структура**:

| **Поле**      | **Тип PostgreSQL** | **Тип Java** | **Описание**              |
|---------------|--------------------|--------------|---------------------------|
| user_id       | SERIAL             | Long         | Уникальный идентификатор  |
| username      | VARCHAR(50)        | String       | Логин пользователя        |
| password_hash | VARCHAR(255)       | String       | Хеш пароля (bcrypt)       |
| email         | VARCHAR(255)       | String       | Электронная почта         |
| full_name     | VARCHAR(100)       | String       | Полное имя                |
| role          | VARCHAR(20)        | String       | Роль (admin/analyst/user) |
| created_at    | TIMESTAMP          | Instant      | Дата создания             |
| last_login    | TIMESTAMP          | Instant      | Последний вход            |
| is_active     | BOOLEAN            | Boolean      | Активен ли пользователь   |

## **2\. Таблица** `groups` **(Группы)**

**Назначение**:

**Структура**:

| **Поле**    | **Тип PostgreSQL** | **Тип Java** | **Описание**             |
|-------------|--------------------|--------------|--------------------------|
| group_id    | SERIAL             | Long         | Уникальный идентификатор |
| name        | VARCHAR(100)       | String       | Название группы          |
| description | TEXT               | String       | Описание группы          |
| created_at  | TIMESTAMP          | Instant      | Дата создания            |
| created_by  | INTEGER            | Long         | Создатель группы         |

## **3\. Таблица** `user_groups` **(Связь пользователей с группами)**

**Назначение**: указание принадлежности пользователя к группам

**Структура**:

| **Поле**  | **Тип PostgreSQL** | **Тип Java** | **Описание**    |
|-----------|--------------------|--------------|-----------------|
| group_id  | INTEGER            | Long         | ID группы       |
| user_id   | INTEGER            | Long         | ID пользователя |
| joined_at | TIMESTAMP          | Instant      | Дата добавления |
| added_by  | INTEGER            | Long         | Кто добавил     |

## **4\. Таблица** `database_connections` **(Подключения к БД)**

**Назначение**: Хранение параметров подключения к источникам данных

**Структура**:

| **Поле**           | **Тип PostgreSQL** | **Тип Java** | **Описание**             |
|--------------------|--------------------|--------------|--------------------------|
| connection_id      | SERIAL             | Long         | Уникальный идентификатор |
| name               | VARCHAR(100)       | String       | Название подключения     |
| db_type            | VARCHAR(50)        | String       | Тип СУБД                 |
| host               | VARCHAR(255)       | String       | Хост подключения         |
| port               | INTEGER            | Integer      | Порт подключения         |
| database_name      | VARCHAR(100)       | String       | Имя базы данных          |
| username           | VARCHAR(100)       | String       | Имя пользователя БД      |
| encrypted_password | TEXT               | String       | Шифрованный пароль       |
| created_at         | TIMESTAMP          | Instant      | Дата создания            |
| created_by         | INTEGER            | Long         | Создатель подключения    |
| is_active          | BOOLEAN            | Boolean      | Активно ли подключение   |

## **5\. Таблица** `reports` **(Отчеты)**

**Назначение**: Хранение SQL-отчетов

**Структура**:

| **Поле**      | **Тип PostgreSQL** | **Тип Java** | **Описание**             |
|---------------|--------------------|--------------|--------------------------|
| report_id     | SERIAL             | Long         | Уникальный идентификатор |
| name          | VARCHAR(255)       | String       | Название отчета          |
| description   | TEXT               | String       | Описание отчета          |
| sql_query     | TEXT               | String       | SQL-код отчета           |
| connection_id | INTEGER            | Long         | Подключение к БД         |
| created_at    | TIMESTAMP          | Instant      | Дата создания            |
| created_by    | INTEGER            | Long         | Создатель отчета         |
| updated_at    | TIMESTAMP          | Instant      | Дата изменения           |
| updated_by    | INTEGER            | Long         | Кто изменил              |
| is_public     | BOOLEAN            | Boolean      | Публичный ли отчет       |

## **6\. Таблица** `report_parameters` **(Параметры отчетов)**

**Назначение**: Хранение параметров для отчетов

**Структура**:

| **Поле**      | **Тип PostgreSQL** | **Тип Java** | **Описание**             |
|---------------|--------------------|--------------|--------------------------|
| parameter_id  | SERIAL             | Long         | Уникальный идентификатор |
| report_id     | INTEGER            | Long         | Ссылка на отчет          |
| name          | VARCHAR(100)       | String       | Имя параметра            |
| param_type    | VARCHAR(50)        | String       | Тип параметра            |
| default_value | TEXT               | String       | Значение по умолчанию    |
| is_required   | BOOLEAN            | Boolean      | Обязательный параметр    |

### Для чего нужная таблица `report_parameters`:

#### **1\. Основные задачи параметров:**

-  **Фильтрация данных**

   Позволяют пользователям выбирать конкретные данные из отчета (например: период, регион, категорию товаров).

-  **Персонализация отчетов**

   Разные пользователи могут получать разные данные из одного отчета, подставляя свои значения параметров.

-  **Защита от SQL-инъекций**

   Параметры обрабатываются безопасно, исключая прямой ввод SQL-кода пользователями

#### **2\. Поля таблицы:**

-  `name`

   Техническое имя параметра, используемое в SQL-запросе (например: `{{region_id}}`).

-  `param_type`

   Определяет тип значения (`date`, `number`, `string`, `boolean`). Влияет на:

   -  Валидацию введенных значений

   -  Формат поля ввода в интерфейсе

   -  Способ подстановки в SQL-запрос

-  `default_value`

   Значение, которое подставляется автоматически (например: текущая дата для `start_date`).

-  `is_required`

   Если `true`, пользователь не сможет запустить отчет без указания значения.

#### **3\. Как работает на практике:**

| **Параметр** | **Тип (**`param_type`**)** | **Пример SQL-запроса с параметром** |
|--------------|----------------------------|-------------------------------------|
| `start_date` | `date`                     | `WHERE date >= {{start_date}}`      |
| `region_id`  | `integer`                  | `WHERE region = {{region_id}}`      |
| `min_sales`  | `number`                   | `WHERE sales > {{min_sales}}`       |
| `category`   | `string`                   | `WHERE category = '{{category}}'`   |

1. Аналитик создает отчет с SQL-запросом:

   ```sql
   SELECT * FROM sales 
   WHERE date BETWEEN {{start_date}} AND {{end_date}}
     AND region_id = {{region_id}}
   ```

2. В таблицу `report_parameters` добавляются параметры:

   ```sql
   INSERT INTO report_parameters VALUES
   (1, 101, 'start_date', 'date', '2023-01-01', true),
   (2, 101, 'end_date', 'date', NULL, true),
   (3, 101, 'region_id', 'integer', '1', false);
   ```

3. Пользователь видит форму ввода параметров:

   -  Обязательные поля: Дата начала, Дата окончания

   -  Опциональное поле: Регион (по умолчанию 1)

## **7\. Таблица** `collections` **(Коллекции)**

**Назначение**: Группировка отчетов по тематикам

**Структура**:

| **Поле**      | **Тип PostgreSQL** | **Тип Java** | **Описание**             |
|---------------|--------------------|--------------|--------------------------|
| collection_id | SERIAL             | Long         | Уникальный идентификатор |
| name          | VARCHAR(255)       | String       | Название коллекции       |
| description   | TEXT               | String       | Описание коллекции       |
| created_at    | TIMESTAMP          | Instant      | Дата создания            |
| created_by    | INTEGER            | Long         | Создатель коллекции      |

## **8\. Таблица** `collection_reports` **(Отчеты в коллекциях)**

**Назначение**: Связь многие-ко-многим между коллекциями и отчетами

**Структура**:

| **Поле**      | **Тип PostgreSQL** | **Тип Java** | **Описание** |
|---------------|--------------------|--------------|--------------|
| collection_id | INTEGER            | Long         | ID коллекции |
| report_id     | INTEGER            | Long         | ID отчета    |

## **9\. Таблица** `collection_access` **(Доступ к коллекциям)**

**Назначение**: Управление правами доступа к коллекциям

**Структура**:

| **Поле**      | **Тип PostgreSQL** | **Тип Java** | **Описание**             |
|---------------|--------------------|--------------|--------------------------|
| access_id     | SERIAL             | Long         | Уникальный идентификатор |
| collection_id | INTEGER            | Long         | ID коллекции             |
| user_id       | INTEGER            | Long         | ID пользователя (null)   |
| group_id      | INTEGER            | Long         | ID группы (null)         |
| access_level  | VARCHAR(20)        | String       | Уровень доступа          |
| granted_at    | TIMESTAMP          | Instant      | Дата выдачи доступа      |
| granted_by    | INTEGER            | Long         | Кто выдал доступ         |

## Описание связей между сущностями

### **1\. Пользователи и группы (N:N)**

**users ↔ user_groups ↔ groups**

-  Связь многие-ко-многим через ассоциативную таблицу `user_groups`

-  **users --> user_groups (1:N)**

   -  Один пользователь может состоять в нескольких группах

   -  Каждая запись в user_groups принадлежит ровно одному пользователю

-  **groups --> user_groups (1:N)**

   -  Одна группа может содержать нескольких пользователей

   -  Каждая запись в user_groups принадлежит ровно одной группе

*Исправление*: В исходном описании пункт 1.2 некорректен - группа может существовать без пользователей (необязательная связь).

### **2\. Пользователи и подключения (1:N)**

**users --> database_connections**

-  Один пользователь может создать несколько подключений (1:N)

-  Каждое подключение принадлежит ровно одному пользователю (обязательная связь)

### **3\. Подключения и отчеты (1:N)**

**database_connections --> reports**

-  Одно подключение может использоваться в нескольких отчетах (1:N)

-  Отчет может не иметь подключения (nullable, необязательная связь)

### **4\. Пользователи и отчеты (1:N)**

**users --> reports**

-  Один пользователь может создать несколько отчетов (1:N)

-  Каждый отчет принадлежит ровно одному пользователю (обязательная связь)

### **5\. Отчеты и параметры (1:N)**

**reports --> report_parameters**

-  Один отчет может иметь несколько параметров (1:N)

-  Каждый параметр принадлежит ровно одному отчету (обязательная связь)

### **6\. Пользователи и коллекции (1:N)**

**users --> collections**

-  Один пользователь может создать несколько коллекций (1:N)

-  Каждая коллекция принадлежит ровно одному пользователю (обязательная связь)

### **7\. Коллекции и отчеты (N:N)**

**collections ↔ collection_reports ↔ reports**

-  Связь многие-ко-многим через ассоциативную таблицу `collection_reports`

-  **collections --> collection_reports (1:N)**

   -  Одна коллекция может содержать несколько отчетов

   -  Каждая запись в collection_reports принадлежит ровно одной коллекции

-  **reports --> collection_reports (1:N)**

   -  Один отчет может входить в несколько коллекций

   -  Каждая запись в collection_reports принадлежит ровно одному отчету

### **8\. Коллекции и доступ (1:N)**

**collections --> collection_access**

-  Одна коллекция может иметь несколько правил доступа (1:N)

-  Каждое правило доступа относится к ровно одной коллекции (обязательная связь)

### **9\. Пользователи и доступ (1:N)**

**users --> collection_access**

-  Один пользователь может иметь доступ к нескольким коллекциям (1:N)

-  Правило доступа может быть выдано пользователю (необязательная связь, user_id nullable)

### **10\. Группы и доступ (1:N)**

**groups --> collection_access**

-  Одна группа может иметь доступ к нескольким коллекциям (1:N)

-  Правило доступа может быть выдано группе (необязательная связь, group_id nullable)

### **11\. Пользователи как создатели доступа (1:N)**

**users --> collection_access (granted_by)**

-  Один пользователь может выдать несколько прав доступа (1:N)

-  Каждое правило доступа выдано ровно одним пользователем (обязательная связь)
